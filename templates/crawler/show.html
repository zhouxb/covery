{% extends 'base.html' %}

{% block nav %}
{% include "nav.html" %}
{% endblock %}

{% block content %}

{% load url from future %}
{% url "crawler:status" crawler.id as crawler_status_url %}
{% url "domain:show" crawler.id as domain_show_url %}


<div class="container-fluid">
  <div class="row-fluid">
    {% include "crawler/sidebar.html" %}
    <div class="span9">

      <h2>检测任务: {{ crawler.name }}</h2>

      <blockquote>
        <ul class="unstyled">
          <code>  检测域名  :</code><strong> {{ crawler.allowed_domain}} </strong>
          <code>  起始地址  :</code><strong> {{ crawler.start_url }} </strong>
          <code>  层级  :</code><strong> {{ crawler.depth_limit }} </strong>
        </ul>
      </blockquote>

      {% if state == "FINISHED" %}
      <span id="task_state" class="label label-success">{{ state }}</span>
      {% endif %}

      {% if state == "FAILURE" or state == "ERROR" %}
      <span id="task_state" class="label label-important">{{ state }}</span>
      {% endif %}

      {% if state == "PROGRESS" or state == "START" %}
      <span id="task_state" class="label label-info">{{ state }}</span>
      {% endif %}

      {% if state == "PENDING" %}
      <span id="task_state" class="label label-warning">{{ state }}</span>
      {% endif %}


      <div id="domain_show">
      </div>

    </div>
  </div>
</div>

<script>

  $("#domain_show").load("{{ domain_show_url }}");

  function update_state(){
    $.get("{{ crawler_status_url }}", function(data){
      if(data["state"] == "FINISHED"){
        state = "label label-success"
      }
      else if(data["state"] == "FAILURE" || data["state"] == "ERROR"){
        state = "label label-important"
      }
      else if(data["state"] == "PROGRESS" || data["state"] == "START"){
        state = "label label-info"
      }
      else{
        state = "label label-warning"
      }

      $("#task_state").attr("class", state)
      $("#task_state").html(data['state'])

    })
    .error(function() { alert("error")});

    $("#domain_show").load("{{ domain_show_url }}");
  }

  {% if not state == 'FAILURE' %}
  setInterval(function(){update_state();}, 3000);
  {% endif %}

</script>

{% endblock %}
